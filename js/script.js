const chatbotLogoFace = `
<svg class="logo--chat" width="43" height="32" viewBox="0 0 43 32" fill="none" xmlns="http://www.w3.org/2000/svg">
<g id="Logo-chat-final">
<path id="Rectangle 1" d="M12.7221 2.06009C18.8008 1.28574 24.0855 1.33464 29.8572 2.08119C36.4622 2.93553 41.1667 8.9512 41.1667 15.8308C41.1667 23.9324 34.5991 30.5 26.4975 30.5H16.2484C8.10309 30.5 1.5 23.8969 1.5 15.7516C1.5 8.89212 6.15342 2.89686 12.7221 2.06009Z" fill="#00AEEF" stroke="#2D2D2D" stroke-width="3"/>
<path class="bgChatbot" id="Rectangle 3" d="M12.6589 1.5641C18.7813 0.784177 24.1089 0.833495 29.9213 1.58532C36.811 2.47649 41.6667 8.73731 41.6667 15.8308C41.6667 24.2085 34.8752 31 26.4975 31H16.2484C7.82695 31 1 24.1731 1 15.7516C1 8.68104 5.80224 2.43756 12.6589 1.5641Z" fill="#00AEEF" stroke="#2D2D2D" stroke-width="2"/>
<path  id="Line 7" d="M5.85516 5.37109C5.57902 5.37109 5.35516 5.59495 5.35516 5.87109C5.35516 6.14724 5.57902 6.37109 5.85516 6.37109V5.37109ZM5.85516 6.37109H16.5347V5.37109H5.85516V6.37109Z" fill="#2D2D2D"/>
<g id="Face-contorn">
<mask id="path-4-inside-1_101_105" fill="white">
<path d="M6.39996 17.4157C6.39996 12.799 10.143 9.0564 14.7598 9.0564C19.6337 9.0564 23.8174 9.0564 28.5336 9.0564C33.1962 9.0564 36.9777 12.8362 36.9777 17.4989V17.4989C36.9777 23.3956 31.0863 27.4758 25.5663 25.4021L24.4516 24.9834C22.4444 24.2293 20.2288 24.2466 18.2336 25.0318L17.8206 25.1944C12.336 27.3528 6.39996 23.3098 6.39996 17.4157V17.4157Z"/>
</mask>
<path d="M6.39996 17.4157C6.39996 12.799 10.143 9.0564 14.7598 9.0564C19.6337 9.0564 23.8174 9.0564 28.5336 9.0564C33.1962 9.0564 36.9777 12.8362 36.9777 17.4989V17.4989C36.9777 23.3956 31.0863 27.4758 25.5663 25.4021L24.4516 24.9834C22.4444 24.2293 20.2288 24.2466 18.2336 25.0318L17.8206 25.1944C12.336 27.3528 6.39996 23.3098 6.39996 17.4157V17.4157Z" fill="white"/>
<path d="M24.4516 24.9834L24.0999 25.9195L24.4516 24.9834ZM18.2336 25.0318L17.8674 24.1013L18.2336 25.0318ZM25.5663 25.4021L25.2146 26.3383L25.5663 25.4021ZM14.7598 10.0564C19.6337 10.0564 23.8174 10.0564 28.5336 10.0564L28.5336 8.0564C23.8174 8.0564 19.6337 8.0564 14.7598 8.0564L14.7598 10.0564ZM25.918 24.466L24.8033 24.0473L24.0999 25.9195L25.2146 26.3383L25.918 24.466ZM17.8674 24.1013L17.4544 24.2638L18.1868 26.1249L18.5998 25.9624L17.8674 24.1013ZM24.8033 24.0473C22.5643 23.2062 20.093 23.2254 17.8674 24.1013L18.5998 25.9624C20.3647 25.2678 22.3245 25.2525 24.0999 25.9195L24.8033 24.0473ZM5.39996 17.4157C5.39996 24.0149 12.0461 28.5416 18.1868 26.1249L17.4544 24.2638C12.6259 26.1641 7.39996 22.6047 7.39996 17.4157H5.39996ZM35.9777 17.4989C35.9777 22.6971 30.7842 26.294 25.918 24.466L25.2146 26.3383C31.3885 28.6575 37.9777 24.094 37.9777 17.4989H35.9777ZM28.5336 10.0564C32.6442 10.0564 35.9777 13.3888 35.9777 17.4989H37.9777C37.9777 12.2837 33.7483 8.0564 28.5336 8.0564L28.5336 10.0564ZM14.7598 8.0564C9.59083 8.0564 5.39996 12.2466 5.39996 17.4157H7.39996C7.39996 13.3514 10.6953 10.0564 14.7598 10.0564L14.7598 8.0564Z" fill="#2D2D2D" mask="url(#path-4-inside-1_101_105)"/>
</g>
<path id="Line 10" d="M36.3121 19.0638L40.8194 19.0118" stroke="#2D2D2D" stroke-linecap="round"/>
<line id="Line 12" x1="23.195" y1="5.94678" x2="23.195" y2="9.48578" stroke="#2D2D2D" stroke-linecap="round"/>
<path id="Line 22" d="M26.4 27.5V25.5" stroke="#2D2D2D" stroke-linecap="round"/>
<circle class="bgChatbot" id="Ellipse 1" cx="16.9556" cy="5.95556" r="1.45556" fill="#00AEEF" stroke="#2D2D2D"/>
<line id="Line 11" x1="23.2554" y1="5.90002" x2="32.9221" y2="5.90002" stroke="#2D2D2D" stroke-linecap="round"/>
<path id="Line 13" d="M33 5.80005L34.9101 4.23723" stroke="#2D2D2D" stroke-linecap="round"/>
<line id="Line 14" x1="1.21112" y1="16.2112" x2="6.90393" y2="16.2112" stroke="#2D2D2D" stroke-linecap="round"/>
<line id="Line 21" x1="7.49976" y1="27.5709" x2="26.3716" y2="27.5709" stroke="#2D2D2D" stroke-linecap="round"/>
<rect class="Eye-left-s" x="15" y="13" width="3.55555" height="7.82222" rx="1.77778" fill="#2D2D2D"/>
<rect class="Eye-right-s" x="24.9556" y="13" width="3.55555" height="7.82222" rx="1.77778" fill="#2D2D2D"/>
</g>
</svg>`;
//////////////////////////////
// HTML TEMPLATES
//////////////////////////////

/*
 * Obtener cuadro de texto con la cara del chatbot
 * @param  {string} text    Texto que va en el cuadro
 * @return {string} ---     Html preparado con el text
 */
const htmlChatbotText = (text) => {
  return `
  <div class="chatbot-msg">
    ${chatbotLogoFace}

    <div class="chatbot-msg-content">
      <p class="chatbot-text">
        ${text}
      </p>
    </div>
  </div>
`;
};

/*
 * Obtener cuadro de texto sin la cara del chatbot
 * @param  {string} text    Texto que va en el cuadro
 * @return {string} ---     Html preparado con el text
 */
const htmlChatbotTextNoface = (text) => {
  return `
  <div class="chatbot-msg chatbot-msg-no-face">
    ${chatbotLogoFace}

    <div class="chatbot-msg-content">
      <p class="chatbot-text">
        ${text}
      </p>
    </div>
  </div>
`;
};

/*
 * Obtener cuadro con las opciones a mostrar
 * @param  {string} text      Texto que va arriba de las opciones
 * @param  {bool}   is_final  Indica si es una pregunta final que no tiene mas opciones debajo
 * @param  {string} prevQuery Indica la opcion anterior que fue seleccionada
 * @param  {string} optons    Opciones a mostrar
 * @return {string} ---       Html con el texto de arriba y las opciones
 */
const htmlChatbotOptions = (text, is_final, prevQuery, ...options) => {
  // Se unen las opciones y se les da el formato
  let htmlOptions = options
    .map((option) => `<p class="chatbot-option">${option}</p>`)
    .join("");

  // Se verifica cuando agregar la opcion de regresar a la pregunta anterior
  if (prevQuery != "Inicio" && htmlOptions != "" && is_final == false) {
    htmlOptions += `<p class="chatbot-option chatbot-option--return">Pregunta anterior ◀</p>`;
  }

  return `
          <div class="chatbot-msg">
            ${chatbotLogoFace}
            <div class="chatbot-msg-content">
              <div class="chatbot-options">
                <p class="chatbot-options-text">
                  ${text}
                </p>
                ${htmlOptions}
              </div>
            </div>
          </div>
  `;
};

/*
 * Obtener cuadro de respuesta del usuario
 * @param  {string} text      Texto ha seleccionado el usuario
 * @return {string} ---       Html con su opcion seleccionada
 */
const htmlUserInput = (text) => {
  return `
  <div class="chatbot-msg chatbot-msg-user">
    ${chatbotLogoFace}
    <div class="chatbot-msg-content">
      <p class="chatbot-text">${text}</p>
    </div>
  </div>`;
};

/*
 * Obtener formulario de calificacion
 * @return {string} ---     Html preparado con el formulario de calificacion
 */
const htmlChatbotFormReview = () => {
  return `
  <div class="chatbot-msg">
    ${chatbotLogoFace}

    <div class="container-stars chatbot-msg-content">
      <form class="form-stars" action="#">
        <div class="star-widget">
          <input
            class="input-star"
            type="radio"
            name="rate"
            id="rate-5"
            value="5"
          />
          <label for="rate-5" class="fa-solid fa-star"></label>
          <input
            class="input-star"
            type="radio"
            name="rate"
            id="rate-4"
            value="4"
          />
          <label for="rate-4" class="fa-solid fa-star"></label>
          <input
            class="input-star"
            type="radio"
            name="rate"
            id="rate-3"
            value="3"
          />
          <label for="rate-3" class="fa-solid fa-star"></label>
          <input
            class="input-star"
            type="radio"
            name="rate"
            id="rate-2"
            value="2"
          />
          <label for="rate-2" class="fa-solid fa-star"></label>
          <input
            class="input-star"
            type="radio"
            name="rate"
            id="rate-1"
            value="1"
          />
          <label for="rate-1" class="fa-solid fa-star"></label>
          <header class="title-star">&nbsp;</header>  
        </div>

        <div class="submit-box">
          <button class="btn-submit-form-stars" type="submit">
            Post
          </button>
        </div>
      </form>
    </div>
  </div>
  `;
};

/*
 * Obtener formulario de contacto
 * @return {string} ---     Html preparado con el formulario de contacto
 */
const htmlChatbotFormContact = () => {
  return `
  <div class="chatbot-msg">
    ${chatbotLogoFace}

    <div class="chatbot-msg-content">
      <form class="form-to-mail" action="#">
        <label for="name">Nombre</label>
        <input id="input-name" type="text" placeholder="Angel Gonzalez" />

        <label for="email">Correo electrónico</label>
        <input
          id="input-email"
          type="text"
          placeholder="angelGlez@hotmail.com"
        />

        <label for="msg">Pregunta/mensaje</label>
        <textarea
          id="input-msg"
          placeholder="(Menos de 100 palabras)"
        ></textarea>

        <button class="btn-submit-form-email" type="submit">
          Enviar
        </button>
      </form>
    </div>
  </div>`;
};

/*
 * Obtener animacion de cargando
 * @return {string} ---     Html preparado con la animacion
 */
const htmlChatbotLoading = () => {
  return `
  <div class="chatbot-msg chatbot-loader">
    ${chatbotLogoFace}

    <div class="chatbot-msg-content loader">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>
`;
};

//////////////////////////////
// HTML INSERT TEMPLATES
//////////////////////////////

const chatbotBox = document.querySelector(".chatbot-box");
const chatbotChat = document.querySelector(".chatbot-chat");

/*
 * Insertar un cuadro de texto del chatbot
 * @param  {string} text      Texto a mostrar
 */
const insertHtmlChatbotText = function (text) {
  blockChatboFace();
  chatbotChat.insertAdjacentHTML("beforeend", htmlChatbotText(text));
  updateChatbotFace();
  updateScrollBar();
};

/*
 * Insertar un cuadro de texto del chatbot sin la cara del mismo
 * @param  {string} text      Texto a mostrar
 */
const insertHtmlChatbotTextNoFace = function (text) {
  blockChatboFace();
  chatbotChat.insertAdjacentHTML("beforeend", htmlChatbotTextNoface(text));
  updateChatbotFace();
  updateScrollBar();
};

/*
 * Insertar el cuadro de animacion
 */
const insertHtmlChatbotLoading = function () {
  blockChatboFace();
  chatbotChat.insertAdjacentHTML("beforeend", htmlChatbotLoading());
  updateChatbotFace();
  updateScrollBar();
};

/*
 * Insertar un cuadro de texto del chatbot sin la cara del mismo
 * @param  {string} text      Texto que va arriba de las opciones
 * @param  {bool}   is_final  Indica si es una pregunta final que no tiene mas opciones debajo
 * @param  {string} prevQuery Indica la opcion anterior que fue seleccionada
 * @param  {string} optons    Opciones a mostrar
 */
const insertHtmlChatbotOptions = function (
  text,
  isFinal,
  prevQuery,
  ...options
) {
  blockChatboFace();
  // Cuando ya hay mas de un chatbotOptions, se bloquea el ultimo chatbotOptions
  if (optionsBox !== undefined) {
    blockLastChatbotOptions();
  }

  // Se inserta el html
  chatbotChat.insertAdjacentHTML(
    "beforeend",
    htmlChatbotOptions(text, isFinal, prevQuery, ...options)
  );
  updateChatbotFace();

  // Actualizamos el ultimo optionsBox
  optionsBox = [...document.querySelectorAll(".chatbot-options")].at(-1);

  // Se agrega el handler para manejar las nuevas opciones
  selectOptionHandler(prevQuery);

  updateScrollBar();
};

/*
 * Insertar un cuadro de texto del usuario
 * @param  {string} text      Texto a mostrar
 */
const insertHtmlUserInput = function (text) {
  blockChatboFace();
  chatbotChat.insertAdjacentHTML("beforeend", htmlUserInput(text));
  updateChatbotFace();
  updateScrollBar();
};

/*
 * Insertar el chatbot review
 */
const insertHtmlChatbotFormReview = function () {
  blockChatboFace();
  chatbotChat.insertAdjacentHTML("beforeend", htmlChatbotFormReview());
  updateChatbotFace();
  updateScrollBar();

  // Habilitamos al ultimo formulario
  formReview = [...document.querySelectorAll(".form-stars")].at(-1);
  activeFormReview();
};

/*
 * Insertar formulario de contacto
 */
const insertHtmlFormContact = function () {
  blockChatboFace();
  chatbotChat.insertAdjacentHTML("beforeend", htmlChatbotFormContact());
  updateChatbotFace();
  updateScrollBar();

  // Habilitamos al ultimo formulario
  formContact = [...document.querySelectorAll(".form-to-mail")].at(-1);
  activeFormContact();
};

///////////////////////
///////////////////////
///////////////////////

// optionsBox mantiene el chatbotOptions actual
let optionsBox = [...document.querySelectorAll(".chatbot-options")].at(-1);
/*
 * Deshabilitar el ultimo chatbotOptions para no darle click
 */
const blockLastChatbotOptions = function () {
  optionsBox.classList.add("block-chatbot-options");
};

const TIMELOADER = 1;
const MSGEROR = "Ha ocurrido un error";

const activeURL = "http://127.0.0.1:8000";
// const activeURL = "http://34.230.152.92:8080";

const URL = `${activeURL}/pregunta/show?parent=`;

/*
 * Obtener datos de la base de datos
 * @param  {string} url   Url para hacerle fetch
 * @param  {string} query Valor para concaternarlo a la url y completarla
 * @return {string} data  Informacion obtenida del fetch a la url completa
 */
const getDataDB = async function (url, query) {
  const data = await fetch(`${url}${query}`)
    .then((response) => response.json())
    .then((data) => data)
    .catch(() => {
      throw MSGEROR;
    });

  return data;
};

const URLCURRENT = `${activeURL}/pregunta/show?nombre=`;

const URLGETCHILDREN = `${activeURL}/pregunta/show?child=`;

const URLGETTEXTCHILD = `${activeURL}/pregunta/text?child=`;

/*
 * Preparar los datos para insertar las opciones en el html
 * @param  {string} query       Valor que indica que opciones y que texto se debe mostrar
 * @param  {bool} prevOption  Indica si se selecciona regresar a la pregunta anterior o no
 */
const prepareHtmlOptionsDB = async function (
  query = "Inicio",
  prevOption = false
) {
  // Esta serie de if's es para cuando se llega a una respuesta final y se muestran las ultimas opciones
  if (query == "Si") {
    console.log("ENTEEEER");
    blockChatboFace();
    blockLastChatbotOptions();
    insertHtmlChatbotTextNoFace("Has seleccionado que sí");
    insertHtmlChatbotText("Nos ayudarías mucho calificando nuestro servicio: ");
    insertHtmlChatbotFormReview();
    updateChatbotFace();
    return;
  }

  if (query == "Hacer otra pregunta") {
    console.log("Reiniciar chatbot");
    prepareHtmlOptionsDB();
    return;
  }

  if (query == "Solicitar información adicional") {
    console.log("Reiniciar chatbot");
    blockChatboFace();
    blockLastChatbotOptions();
    insertHtmlFormContact();
    updateChatbotFace();
    return;
  }

  let dataOptions;
  let dataQnParent;
  // En caso de que se selecciona una opcion normal
  if (prevOption == false) {
    dataQnParent = await getDataDB(URLCURRENT, query).catch((err) => err);
    dataOptions = await showLoader(TIMELOADER).then(() =>
      getDataDB(URL, query).catch((err) => err)
    );
  }
  // En caso de que se selecciona la opcion de regresar a la opcion anterior
  else {
    dataQnParent = await getDataDB(URLGETTEXTCHILD, query).catch((err) => err);
    dataOptions = await showLoader(TIMELOADER).then(() =>
      getDataDB(URLGETCHILDREN, query).catch((err) => err)
    );
  }

  // Atrapando los errores que pudieron generarse al hacer el fetch
  if (dataQnParent == MSGEROR || dataOptions == MSGEROR) {
    removeLoader();
    blockChatboFace();
    insertHtmlChatbotText("Ha ocurrido un error");
    updateChatbotFace();
    return;
  }

  // Del texto obtenido para mostrar en las opciones, se cambian los saltos de linea por <br>
  let textOption;
  dataQnParent[0].texto.includes("\n")
    ? (textOption = dataQnParent[0].texto.replaceAll("\n", "<br>"))
    : (textOption = dataQnParent[0].texto);

  // Se unen los nombre de las opciones con su emoji
  const htmlOptions = dataOptions.map(
    (option) => `${option.nombre} ${option.emoji}`
  );

  removeLoader();

  // En caso de que se haya seleccionala opcion de "Contacto" se muestra el formulario
  if (dataQnParent[0].texto == "mostrarFormulario()") {
    console.log("SIUUUUUUUUU");
    blockChatboFace();
    insertHtmlFormContact();
    updateChatbotFace();
    return;
  }

  blockChatboFace();
  // Finalmente se insertan las opciones obtenidas de la base de datos
  insertHtmlChatbotOptions(
    textOption,
    dataQnParent[0].is_final,
    dataQnParent[0].nombre,
    ...htmlOptions
  );
  updateChatbotFace();

  // Cuando se llegar a una pregunta final, se muestran las siguientes opciones a manera de cierre
  if (dataOptions.length == 0) {
    showLoader(TIMELOADER).then(() => {
      removeLoader();
      blockChatboFace();

      insertHtmlChatbotOptions(
        "¿Pudimos ayudarte a encontrar lo que buscabas?",
        true,
        "",
        ...[
          "Si 🎈",
          "Hacer otra pregunta 🎈",
          "Solicitar información adicional 🎈",
        ]
      );
      updateChatbotFace();

      return;
    });
  }
  return;
};

/*
 * Baja el cursor hasta abajo cada que se inserta un elemento
 */
const updateScrollBar = function () {
  chatbotChat.scrollTo(0, chatbotChat.scrollHeight);
};

const chatbotFace = document.querySelector(".chatbot-face");
const chatbotExit = document.querySelector(".chatbot-close-button");
const msgWelcome = "Hola, este es un mensaje de bienvenida";
let flagChatbotOpen = false;
/*
 * Mostrar y ocultar la cara del chatbot y la caja del chatbot
 */
const handleShowChatbot = (function () {
  // Para abrir el chabtotChat al hacer click en la cara
  chatbotFace.addEventListener("click", function () {
    // Se oculta y visibiliza la cara y la caja del chatbot respectivamente
    chatbotBox.classList.toggle("hidden");
    chatbotFace.classList.toggle("hidden");

    // Solo entra a este if cuando se abre por primera vez el chatbot
    if (!flagChatbotOpen) {
      insertHtmlChatbotText(msgWelcome);
      blockChatboFace();
      updateChatbotFace();
      flagChatbotOpen = true;
      prepareHtmlOptionsDB();
    }
  });

  // Para cerrar el chatbotChat al hacer click en la x
  chatbotExit.addEventListener("click", function () {
    // Se oculta y visibiliza la cara y la caja del chatbot respectivamente
    chatbotBox.classList.toggle("hidden");
    chatbotFace.classList.toggle("hidden");
  });

  updateScrollBar();
})(); // La funciona se llama automaticamente una vez creada

///////////////////////
///////////////////////
///////////////////////

/*
 * Manejar cuando se selecciona una de las opciones mostradas
 * @param  {string} prevQuery   Opcion padre (anterior) de la opcion seleccionada
 */
const selectOptionHandler = function (prevQuery) {
  // Para seleccionar una opcion se hace event delegation:
  // 1. Se agrega un event listener al elemento padre comun
  // 2. Se determina que elemento hijo origino el evento

  optionsBox.addEventListener("click", function (e) {
    if (e.target.classList.contains("chatbot-option")) {
      insertHtmlUserInput(e.target.textContent);

      // De la opcion seleccionada, se quita el emoji
      const strNoEmoji = e.target.textContent.split(" ").slice(0, -1).join(" ");

      // Se verifica si la opcion seleccionada es la de regresa a la anterior
      if (strNoEmoji == "Pregunta anterior") {
        prepareHtmlOptionsDB(prevQuery, true);
        return;
      }

      // Se preparan las nuevas opciones en base a la seleccionada
      prepareHtmlOptionsDB(strNoEmoji);
    }
  });
};

const URLPOSTCALIFICACION = `${activeURL}/calificacion/create`;
/*
 * Publicar la calificacion obtenida en el formulario
 * @param  {int}      score   Calificacion del formulario
 * @return {promise}  -----   Fetch con la url para subir la calificacion y sus opciones
 */
const postScoreDB = async function (score) {
  const options = {
    method: "POST",
    headers: {
      Accept: "application/json",
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      calificacion: score,
    }),
  };

  return fetch(URLPOSTCALIFICACION, options);
};

let formReview = [...document.querySelectorAll(".form-stars")].at(-1);
/*
 * Habilitar el formReview para aceptar calificaciones
 */
const activeFormReview = function () {
  formReview.addEventListener("submit", function (e) {
    e.preventDefault();

    // Se obtiene la respuesta del formulario
    const answer = document.querySelector('input[name="rate"]:checked')?.value;

    // En caso de que no se haya selecionado ninguna calificacion
    if (!answer) {
      return;
    }

    // Se bloquea el formulario para no aceptar más inputs
    formReview.style.pointerEvents = "none";

    showLoader(TIMELOADER).then(() => {
      postScoreDB(answer)
        .then((response) => response.json())
        .then((data) => {
          blockChatboFace();
          insertHtmlChatbotText(data);
          updateChatbotFace();
          removeLoader();
        })
        .catch(() => {
          blockChatboFace();
          insertHtmlChatbotText("Ocurrio un error");
          updateChatbotFace();
          removeLoader();
        });
    });
  });
};

const URLPOSTPERSONA = `${activeURL}/persona/create`;
/*
 * Publicar los datos de una persona obtenidos del formulario de contacto
 * @param  {obj}      persona  Objeto persona con su informacion
 * @return {promise}  -----    Fetch con la url para subir a la persona y sus opciones
 */
const postPersonDB = async function (persona) {
  const options = {
    method: "POST",
    headers: {
      Accept: "application/json",
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      nombre: persona.nombre,
      correo: persona.correo,
      descripcion: persona.descripcion,
    }),
  };

  return fetch(URLPOSTPERSONA, options);
};

let formContact = [...document.querySelectorAll(".form-to-mail")].at(-1);
/*
 * Habilitar el formContact para aceptar datos de personas
 */
const activeFormContact = function () {
  // Formulario de los datos
  formContact.addEventListener("submit", function (e) {
    e.preventDefault();

    // Mansajes de error
    const errorName = "Error al ingresar el nombre. Intenta de nuevo";
    const errorEmail = "Error al ingresar mail. Intenta de nuevo";
    const errorMsg = "Error al ingresa el mensaje. Intenta de nuevo";

    // Se obtienen los valores dados por el usuario
    const name = e.target[0].value;
    const email = e.target[1].value;
    const msg = e.target[2].value;

    let isError = false;

    // Verificacion de los tres datos dados por el usuario
    if (!checkName(name)) {
      const placeholderName = document.querySelector("#input-name");
      placeholderName.placeholder = errorName;
      placeholderName.classList.add("error-input-form");
      isError = true;
      e.target[0].value = "";
    }

    if (!checkEmail(email)) {
      const placeholderEmail = document.querySelector("#input-email");
      placeholderEmail.placeholder = errorEmail;
      placeholderEmail.classList.add("error-input-form");
      isError = true;
      e.target[1].value = "";
    }

    if (!checkMessage(msg)) {
      const placeholderMsg = document.querySelector("#input-msg");
      placeholderMsg.placeholder = errorMsg;
      placeholderMsg.classList.add("error-input-form");
      isError = true;
      e.target[2].value = "";
    }

    if (!isError) {
      // En caso de que no haya errores
      formContact.style.pointerEvents = "none"; // Se bloquea el formulario para no aceptar más información

      const newPerson = {
        nombre: name,
        correo: email,
        descripcion: msg,
      };

      showLoader(TIMELOADER).then(() => {
        postPersonDB(newPerson)
          .then((response) => response.json())
          .then((data) => {
            blockChatboFace();
            insertHtmlChatbotText(
              `Muchas gracias, ${data.nombre}. Hemos recibido tus datos`
            );
            updateChatbotFace();
            removeLoader();
          })
          .catch((err) => {
            blockChatboFace();
            console.log("Ocurrio un error");
            insertHtmlChatbotText("Ocurrio un error");
            updateChatbotFace();
            removeLoader();
          });
      });
    }
  });
};

///////////////////////
///////////////////////
///////////////////////

/*
 * Habilitar la barra de busqueda del usuario
 */
const activateSearchBar = (function () {
  const searchBarEl = document.querySelector(".search-bar");

  searchBarEl.addEventListener("keyup", function (e) {
    e.preventDefault();
    if (e.key === "Enter" || e.keyCode === 13) {
      blockChatboFace();
      insertHtmlUserInput(searchBarEl.value);
      updateChatbotFace();
      searchBarEl.value = "";
    }
  });
})();

/*
 * Mostrar el loader de cargando
 * @param  {int}      sec      Cuantos segundos debe aparecer
 * @return {promise}  -----    Promesa que incluye un tiempo de espera
 */
const showLoader = function (sec) {
  return new Promise(function (resolve) {
    chatbotChat.insertAdjacentHTML("beforeend", htmlChatbotLoading());
    updateScrollBar();

    setTimeout(resolve, 1000 * sec);
  });
};

/*
 * Quitar el loader de cargando
 */
const removeLoader = function () {
  lastLoaderElement = [...document.querySelectorAll(".chatbot-loader")].at(-1);
  lastLoaderElement.remove();
  updateScrollBar();
};

/*
 * Verificar nombre del formulario con regex
 * @param  {string}   name    Nombre a revisar
 * @return {bool}     ----    Depende si name cumple la regex
 */
const checkName = (name) => {
  const re = new RegExp(/^[a-zA-Z ]+$/);
  return re.test(name);
};

/*
 * Verificar correo del formulario con regex
 * @param  {string}   mail    Correo a revisar
 * @return {bool}     ----    Depende si correo cumple la regex
 */
const checkEmail = (mail) => {
  const re = new RegExp(
    /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/
  );
  return re.test(mail);
};

/*
 * Verificar mensaje del formulario con regex
 * @param  {string}   msg    Mensaje a revisar
 * @return {bool}     ----    Depende si mensaje cumple la regex
 */
const checkMessage = (msg) => {
  const maxWords = 100;
  const numWords = msg.trim().split(" ").length;

  if (numWords < maxWords && numWords >= 1 && msg.trim().split(" ")[0] !== "") {
    return true;
  } else {
    return false;
  }
};

//////////////////////////////
//////////////////////////////
//////////////////////////////
//////////////////////////////
//////////////////////////////

//////////////////////////////
// Menu to add texts box in the chatbot
//////////////////////////////

const btnChatbotText = document.querySelector(".btn-chatbot-text-face");
const btnChatbotTextNoface = document.querySelector(
  ".btn-chatbot-text-no-face"
);
const btnChatbotReview = document.querySelector(".btn-chatbot-review");
const btnChatbotLoading = document.querySelector(".btn-chatbot-loading");
const btnChatbotOptions = document.querySelector(".btn-chatbot-options");
const btnChatbotUser = document.querySelector(".btn-chatbot-user");
const btnChatbotForm = document.querySelector(".btn-form");

const someText =
  "Lorem ipsum dolor sit amet consectetur adipisicing elit. Ipsum libero, sit eum voluptates natus voluptatem dolorum. Beatae sit.";

btnChatbotText.addEventListener("click", function () {
  insertHtmlChatbotText(someText);
});

btnChatbotTextNoface.addEventListener("click", function () {
  insertHtmlChatbotTextNoFace(someText);
});

btnChatbotLoading.addEventListener("click", function () {
  insertHtmlChatbotLoading();
});

btnChatbotOptions.addEventListener("click", function () {
  // Insertamos las nuevas opciones

  showLoader(TIMELOADER).then(() => {
    removeLoader();

    prepareHtmlOptionsDB();
  });
});

btnChatbotUser.addEventListener("click", function () {
  insertHtmlUserInput(someText);
});

btnChatbotReview.addEventListener("click", function () {
  insertHtmlChatbotFormReview();
});

btnChatbotForm.addEventListener("click", function () {
  insertHtmlFormContact();
});

//
//
//
//
// Para la cara feliz
let lastChatbotFace = [...document.querySelectorAll(".logo--chat")].at(-1);
let lastEyeLeft = [...document.querySelectorAll(".Eye-left-s")].at(-1);
let lastEyeRight = [...document.querySelectorAll(".Eye-right-s")].at(-1);

const blockChatboFace = function () {
  if (lastChatbotFace != undefined) {
    lastChatbotFace.classList.add("block-chatbot-logo--chat");
  }
};

const updateChatbotFace = function () {
  lastChatbotFace = [...document.querySelectorAll(".logo--chat")].at(-1);

  lastEyeLeft = [...document.querySelectorAll(".Eye-left-s")].at(-1);
  lastEyeRight = [...document.querySelectorAll(".Eye-right-s")].at(-1);
};

const changeEyes = function () {
  updateChatbotFace();
  lastEyeLeft.remove();
  lastChatbotFace.insertAdjacentHTML(
    "beforeEnd",
    '<path class="Eye-left" d="M12 15.6194C15.3948 14.8909 16.949 15.2606 18.3386 19" stroke="#2D2D2D" stroke-width="1.5" stroke-linecap="round"/>'
  );

  lastEyeRight.remove();
  lastChatbotFace.insertAdjacentHTML(
    "beforeEnd",
    '<path class="Eye-Right" d="M29.5949 15.6194C26.2001 14.8909 24.6459 15.2606 23.2563 19" stroke="#2D2D2D" stroke-width="1.5" stroke-linecap="round"/>'
  );
};
